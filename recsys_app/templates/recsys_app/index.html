{% load static %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>User-based Recommendation System | TAU | NLF</title>
		<link rel="stylesheet" href="{% static 'css/main_page_style.css' %}">
	</head>

<body>
	<div class="navbar">
		<a href="{% url 'main_page' %}" class="home">Home</a>
		<a href="{% url 'about_us' %}">About Us</a>
	</div>

	<div class="container">

		<div class="imageContainer">
			<img src="https://www.topuniversities.com/sites/default/files/profiles/logos/tampere-university_5bbf14847d023f5bc849ec9a_large.jpg" alt="Left Image">
			<img src="https://netpreserve.org/resources/logo_KK.fi_-150x150.png" alt="Right Image">	
		</div>
	
		<div class="search-container">
			<h2>Hi there, <i>{{ user_name|safe }}</i> &#128521;</h2>
			<h3>{{ welcome_text|safe }}</h3>

			<form method="post" action="{% url 'main_page' %}" id="searchForm">
				<input type="hidden" name="isRecSys" id="isRecSys" value="false">
				{% csrf_token %}
				<input type="text" name="query" placeholder="Query prompt (Example: Suomen sosialistinen tasavalta)">
				
				<div class="help">
					<a href="{% url 'help' %}">Search Instruction</a>
				</div>
				
				<div class="button-container">
					<input type="button" value="Search NLF" onclick="searchNLF()">
					<input type="button" value="Clear" onclick="cleanSearch()">
				</div>
				
				<div id="libraryLinkContainer"></div>
				
				<div class="button-container">
					<input type="submit" value="Recommend Me" onclick="recommendMe(event)">
					<input type="button" value="Clear" onclick="cleanRecSys()">
				</div>

				<div class="loading-container">
					<div id="loadingSpinner" class="loading-spinner">
						<p id="loadingText" class="spinner-text">Please Wait (~2.0 min)...</p>
					</div>
				</div>
			</form>
			</div>

			<!-- #################################### functional  ####################################-->
			<!-- <div class="slider-container">
				{% if recommendation_results %}
					<label for="recSysSlider" id="recSysSliderLbl">Number of RecSys Results:</label>
					<input type="range" id="recSysSlider" name="recSysSlider" min="3" max="20" value="5" oninput="updateSliderValue(this.value)">
					<span id="sliderValueDisplay">5</span>
				{% endif %}
			</div>

			<div id="recSysIntroContainer">
				{% if recommendation_results %}
					<p>Since you Searched<br> <b>{{input_query}}</b> <br>You might be also interested in<br></p>
				{% endif %}
			</div>

			<div id="recSysResultsContainer"></div>-->
			<!-- #################################### functional  ####################################-->

			<div class="recommendation-container">
				{% if recommendation_results %}
					<div class="slider-container">
							<label for="recSysSlider" id="recSysSliderLbl">Number of RecSys Results:</label>
							<input type="range" id="recSysSlider" name="recSysSlider" min="3" max="20" value="5" oninput="updateSliderValue(this.value)">
							<span id="sliderValueDisplay">5</span>
					</div>
					
					<div id="recSysIntroContainer">
						
						<div>
							<p>Since you Searched</p>
						</div>
						
						<div>
							<h1 class="glow">{{input_query}}</h1>
						</div>

						<div>
							<p>You might be also interested in</p>
						</div>

					</div>
					
					<div id="recSysResultsContainer"></div>
				{% endif %}
			</div>
	</div>

	<script>
		let globalQuery = `{{ input_query|safe }}`;
	</script>

	<script>
		var digi_base_url = "https://digi.kansalliskirjasto.fi/search?query=";
	</script>

	<script>
		function searchNLF() {
			var query = document.getElementsByName("query")[0].value.trim();
			if (query !== "") {
				var libLinkContainer = document.getElementById("libraryLinkContainer");
				var libLink = digi_base_url + encodeURIComponent(query)
				libLinkContainer.innerHTML = "<a href='" + libLink + "' target='_blank'>Click here to open National Library Results</a>";
			} else {
					alert('Oops! Enter a valid search query to proceed!');
				}
		}
		function cleanSearch() {
			document.getElementById("libraryLinkContainer").innerHTML = "";
			document.getElementsByName("query")[0].value = "";
			document.getElementsByName("query")[0].placeholder = "Query prompt (Example: Suomen sosialistinen tasavalta)";
		}
		function showLoadingSpinner() {
			document.getElementById("loadingSpinner").style.display = "flex";
		}
		function hideLoadingSpinner() {
			document.getElementById("loadingSpinner").style.display = "none";
		}
		function recommendMe(event) {
			var query = document.getElementsByName("query")[0].value.trim();
			document.getElementById("isRecSys").value = true; // Update the hidden input field
			showLoadingSpinner();
			if (query !== "") {
				document.getElementById("searchForm").submit();
			} else {
				alert('Oops! Enter a valid search query to proceed!');
				hideLoadingSpinner();
				event.preventDefault();
			}
		}
		function cleanRecSys() {
			document.getElementsByName("query")[0].value = "";
			document.getElementsByName("query")[0].placeholder = "Query prompt (Example: Suomen sosialistinen tasavalta)";
			document.getElementById("recSysIntroContainer").remove();
			document.getElementById("recSysResultsContainer").remove();
			document.getElementById("recSysSlider").remove();
			document.getElementById("sliderValueDisplay").remove();
			document.getElementById("recSysSliderLbl").remove();
		}
		function updateSliderValue(sliderValue) {
			document.getElementById('recSysSlider').value = sliderValue;
			document.getElementById('sliderValueDisplay').textContent = sliderValue;
			updateResultsBasedOnSliderValue();
		}
	</script>

	<script>
		var recommendationResults;
		try {
			recommendationResults = {{ recommendation_results|safe }};
		} catch (error) {
			alert(`Sorry! ${globalQuery} NOT found in our database! Search something else!`);
			recommendationResults = null;
			hideLoadingSpinner();
			event.preventDefault();
		}

		document.addEventListener("DOMContentLoaded", function() {
			updateResultsBasedOnSliderValue();
		});

		function updateResultsBasedOnSliderValue() {
			var sliderValue = document.getElementById('recSysSlider').value;
			var recsysRes = document.getElementById('recSysResultsContainer');
			recsysRes.innerHTML = "";
			for (let i = 0; i < sliderValue; i++) {
				var recSysLink_i = digi_base_url + encodeURIComponent(globalQuery + " " + recommendationResults[i]);
				recsysRes.innerHTML += `<p><a href='${recSysLink_i}' target='_blank'><span style="font-size: 75%;">${globalQuery}</span> + ${recommendationResults[i]}</a></p>`;
			}
		}
	</script>
</body>

</html>